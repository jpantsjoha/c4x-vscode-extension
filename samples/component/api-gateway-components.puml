@startuml API Gateway - Component Diagram
!include https://raw.githubusercontent.com/plantuml-stdlib/C4-PlantUML/master/C4_Component.puml

LAYOUT_WITH_LEGEND()

title Component diagram for API Gateway Container

' External Containers
Container(webApp, "Web Application", "React", "User interface")
Container_Ext(userService, "User Service", "Go", "User management")
Container_Ext(productService, "Product Service", "Java", "Product catalog")
Container_Ext(orderService, "Order Service", "Python", "Order processing")

' API Gateway Boundary
Container_Boundary(apiGateway, "API Gateway") {
    ' Entry Point
    Component(gatewayController, "Gateway Controller", "Express Router", "Handles incoming HTTP requests")

    ' Middleware Components
    Component(authMiddleware, "Authentication Middleware", "JWT Validator", "Validates authentication tokens")
    Component(rateLimiter, "Rate Limiter", "Redis-backed", "Prevents API abuse")
    Component(corsHandler, "CORS Handler", "Express Middleware", "Handles CORS policies")

    ' Routing Components
    Component(requestRouter, "Request Router", "Route Matcher", "Routes requests to backend services")
    Component(serviceRegistry, "Service Registry", "Consul Client", "Discovers backend service instances")
    Component(loadBalancer, "Load Balancer", "Round Robin", "Distributes load across instances")
    Component(circuitBreaker, "Circuit Breaker", "Hystrix", "Prevents cascading failures")

    ' Observability Components
    Component(logger, "Request Logger", "Winston", "Logs all requests and responses")
    Component(metricsCollector, "Metrics Collector", "Prometheus", "Collects performance metrics")
    Component(tracer, "Distributed Tracer", "OpenTelemetry", "Traces requests across services")

    ' Caching
    ComponentDb(responseCache, "Response Cache", "Redis", "Caches frequent responses")

    ' Request Flow
    Rel(gatewayController, authMiddleware, "Validates request", "Middleware chain")
    Rel(gatewayController, rateLimiter, "Checks rate limit", "Middleware chain")
    Rel(gatewayController, corsHandler, "Applies CORS policy", "Middleware chain")
    Rel(gatewayController, requestRouter, "Routes request", "")

    Rel(gatewayController, logger, "Logs request/response", "Async")
    Rel(gatewayController, metricsCollector, "Records metrics", "Async")
    Rel(gatewayController, tracer, "Creates trace span", "")

    ' Service Discovery & Load Balancing
    Rel(requestRouter, serviceRegistry, "Discovers services", "HTTP/DNS")
    Rel(requestRouter, loadBalancer, "Selects instance", "")
    Rel(requestRouter, responseCache, "Checks cache", "")
    Rel(loadBalancer, circuitBreaker, "Forwards request", "")

    ' Circuit Breaker to Backend Services
    Rel(circuitBreaker, logger, "Logs errors", "Async")
    Rel(circuitBreaker, metricsCollector, "Records failures", "Async")
}

' External Relationships
Rel(webApp, gatewayController, "Makes API calls", "JSON/HTTPS")
Rel(circuitBreaker, userService, "Proxies request", "gRPC")
Rel(circuitBreaker, productService, "Proxies request", "HTTP/REST")
Rel(circuitBreaker, orderService, "Proxies request", "HTTP/REST")

@enduml
